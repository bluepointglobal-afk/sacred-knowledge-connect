{
  "feature": "stripe-payments-complete",
  "version": "2.0.0",
  "priority": "P0",
  "verifiers": [
    "test -f supabase/functions/create-checkout-session/index.ts && echo 'Checkout function exists'",
    "test -f supabase/functions/stripe-webhook/index.ts && echo 'Webhook function exists'",
    "test -f supabase/functions/create-connect-account/index.ts && echo 'Connect function exists'",
    "test -f supabase/functions/request-payout/index.ts && echo 'Payout function exists'",
    "grep -q 'escrow' src/hooks/usePayments.ts && echo 'Escrow logic in hooks'",
    "npm run build 2>&1 | head -50"
  ],
  "stories": [
    {
      "id": "SP-07",
      "title": "Session Purchase Checkout",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Enable students to purchase single hourly sessions from teacher profiles",
      "acceptance": [
        "useSessionCheckout.ts hook created",
        "create-checkout-session handles session type",
        "SessionCheckoutButton.tsx renders on teacher profile",
        "Session created with status 'scheduled' after payment",
        "Payment record linked to session_id"
      ],
      "tasks": [
        "Create useSessionCheckout.ts hook",
        "Update create-checkout-session Edge Function for session type",
        "Create SessionCheckoutButton.tsx component",
        "Add checkout flow to teacher profile page",
        "Handle session creation on checkout success webhook"
      ]
    },
    {
      "id": "SP-08",
      "title": "Escrow Hold System",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Hold payments in escrow until session is confirmed complete",
      "acceptance": [
        "New payments start with status 'held' not 'completed'",
        "teacher_earnings created with status 'pending'",
        "escrow_released_at column exists on payments",
        "available_at column exists on teacher_earnings",
        "Earnings dashboard shows pending vs available amounts"
      ],
      "tasks": [
        "Add escrow_released_at column to payments",
        "Add available_at column to teacher_earnings",
        "Update webhook to create payment with status 'held'",
        "Update webhook to create earning with status 'pending'",
        "Update earnings dashboard UI to show pending vs available"
      ]
    },
    {
      "id": "SP-09",
      "title": "Escrow Release Logic",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Automatically release escrow 24 hours after session completion",
      "acceptance": [
        "release-escrow Edge Function created",
        "Session completion triggers escrow timer (available_at = now + 24h)",
        "Mature escrows release automatically (payment 'completed', earning 'available')",
        "Student no-show releases funds to teacher",
        "Teacher no-show triggers refund"
      ],
      "tasks": [
        "Create release-escrow Edge Function",
        "Add trigger on session status change to 'completed'",
        "Set available_at to NOW() + 24 hours on completion",
        "Create pg_cron job to release mature escrows",
        "Handle no-show scenarios"
      ]
    },
    {
      "id": "SP-10",
      "title": "Stripe Connect Onboarding",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Enable teachers to receive payouts via Stripe Connect",
      "acceptance": [
        "create-connect-account Edge Function created",
        "create-connect-link Edge Function created",
        "TeacherStripeSetup.tsx page created",
        "stripe_account_id stored after Connect creation",
        "Connect status shown on teacher dashboard",
        "Payout blocked if Connect not verified"
      ],
      "tasks": [
        "Create create-connect-account Edge Function",
        "Create create-connect-link Edge Function",
        "Create TeacherStripeSetup.tsx page",
        "Handle account.updated webhook event",
        "Add Connect status indicator to dashboard"
      ]
    },
    {
      "id": "SP-11",
      "title": "Payout Request System",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Teachers can request payouts of available earnings",
      "acceptance": [
        "request-payout Edge Function created",
        "RequestPayoutButton.tsx component created",
        "PayoutHistory.tsx component created",
        "Minimum payout validation ($50)",
        "Payout creates Stripe Transfer to Connected account",
        "Payout history shows all requests with status"
      ],
      "tasks": [
        "Create request-payout Edge Function",
        "Create RequestPayoutButton.tsx",
        "Create PayoutHistory.tsx",
        "Validate minimum $50 payout",
        "Validate Connect account active",
        "Create Stripe Transfer on request"
      ]
    },
    {
      "id": "SP-12",
      "title": "Complete Webhook Handler",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Handle all Stripe webhook events reliably",
      "acceptance": [
        "checkout.session.completed handled",
        "payment_intent.payment_failed handled",
        "charge.refunded handled (updates payment + forfeits earning)",
        "charge.dispute.created handled (holds earning)",
        "account.updated handled (Connect status)",
        "transfer.created/failed handled",
        "payout.paid/failed handled",
        "Idempotency checks prevent duplicate processing"
      ],
      "tasks": [
        "Handle checkout.session.completed",
        "Handle payment_intent.payment_failed",
        "Handle charge.refunded",
        "Handle charge.dispute.created",
        "Handle account.updated",
        "Handle transfer events",
        "Handle payout events",
        "Add idempotency checks"
      ]
    },
    {
      "id": "SP-13",
      "title": "Edge Functions Deployment",
      "passes": true,
      "branch": "feat/stripe-payments",
      "description": "Deploy and test all Edge Functions in production",
      "acceptance": [
        "create-checkout-session deployed",
        "stripe-webhook deployed",
        "create-connect-account deployed",
        "create-connect-link deployed",
        "request-payout deployed",
        "release-escrow deployed",
        "Webhook URL configured in Stripe",
        "End-to-end payment flow works",
        "End-to-end payout flow works"
      ],
      "tasks": [
        "Create supabase/functions/create-checkout-session/index.ts",
        "Create supabase/functions/stripe-webhook/index.ts",
        "Create supabase/functions/create-connect-account/index.ts",
        "Create supabase/functions/create-connect-link/index.ts",
        "Create supabase/functions/request-payout/index.ts",
        "Create supabase/functions/release-escrow/index.ts",
        "Deploy functions with supabase functions deploy",
        "Configure Stripe webhook endpoint",
        "Test end-to-end flows"
      ]
    }
  ],
  "config": {
    "platform_fee_percent": 15,
    "teacher_share_percent": 85,
    "minimum_payout_cents": 5000,
    "escrow_hold_hours": 24,
    "currency": "usd"
  },
  "metadata": {
    "created_at": "2025-01-20",
    "updated_at": "2025-01-21",
    "source": "tasks/tasks-stripe-payments.md",
    "total_stories": 7,
    "completed_stories": 7,
    "feature_id": "P0",
    "depends_on": ["SP-01", "SP-02", "SP-03", "SP-04", "SP-05", "SP-06"]
  }
}
